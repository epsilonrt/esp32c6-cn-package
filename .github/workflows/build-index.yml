name: Build package index

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to test"
        required: true
        default: "0.9.2"

jobs:
  generate-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set tag and URL
        id: vars
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            echo "url=https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.inputs.tag }}.zip" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "url=${{ github.event.release.zipball_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Debug tag and URL
        run: |
          echo "Using tag: ${{ steps.vars.outputs.tag }}"
          echo "Using URL: ${{ steps.vars.outputs.url }}"

      - name: Download release zip
        run: curl -L ${{ steps.vars.outputs.url }} -o release.zip

      - name: Extract and clean zip
        run: |
          mkdir src
          unzip release.zip -d src
          ROOT=$(ls src)
          mkdir clean
          cp -r src/$ROOT/hardware clean/
          cd clean
          zip -r ../esp32c6-cn-package-${{ steps.vars.outputs.tag }}.zip hardware

      - name: Compute SHA256
        id: sha
        run: echo "sha=$(sha256sum esp32c6-cn-package-${{ steps.vars.outputs.tag }}.zip | cut -d ' ' -f1)" >> $GITHUB_OUTPUT

      - name: Generate package_esp32c6_cn_index.json
        run: |
          sed "s|@RELEASE_VERSION@|${{ steps.vars.outputs.tag }}|g; \
               s|@URL@|https://github.com/${{ github.repository }}/releases/download/${{ steps.vars.outputs.tag }}/esp32c6-cn-package-${{ steps.vars.outputs.tag }}.zip|g; \
               s|@SHA-256@|${{ steps.sha.outputs.sha }}|g" \
               package_template.json > package_esp32c6_cn_index.json

      - name: Upload assets to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: "Release ${{ steps.vars.outputs.tag }}"
          files: |
            esp32c6-cn-package-${{ steps.vars.outputs.tag }}.zip
            package_esp32c6_cn_index.json

        - name: Push latest JSON to gh-pages
          run: |
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git fetch origin gh-pages || true
            git checkout --orphan gh-pages
            git reset --hard
            rm -rf *
            git add package_esp32c6_cn_index.json
            git commit -m "Update latest package index for ${{ steps.vars.outputs.tag }}" || echo "No changes to commit"
            git push -f origin gh-pages
name: Build package index

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to test"
        required: true
        default: "0.9.2"

jobs:
  generate-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get release info
        id: release
        uses: actions/github-script@v6
        with:
          script: |
            core.setOutput('tag', context.payload.release.tag_name)
            core.setOutput('url', context.payload.release.zipball_url)

      - name: Download release zip
        run: curl -L ${{ steps.release.outputs.url }} -o release.zip

      - name: Extract and clean zip
        run: |
          mkdir src
          unzip release.zip -d src
          # GitHub auto-generated zip contains a dynamic folder name (repo-commit)
          ROOT=$(ls src)
          mkdir clean
          cp -r src/$ROOT/hardware clean/
          cd clean
          # Recreate a clean zip with only hardware/
          zip -r ../esp32c6-cn-package-${{ steps.release.outputs.tag }}.zip hardware

      - name: Compute SHA256
        id: sha
        run: echo "sha=$(sha256sum esp32c6-cn-package-${{ steps.release.outputs.tag }}.zip | cut -d ' ' -f1)" >> $GITHUB_OUTPUT

      - name: Generate package_esp32c6_cn_index.json
        run: |
          sed "s|@RELEASE_VERSION@|${{ steps.release.outputs.tag }}|g; \
               s|@URL@|https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/esp32c6-cn-package-${{ steps.release.outputs.tag }}.zip|g; \
               s|@SHA-256@|${{ steps.sha.outputs.sha }}|g" \
               package_template.json > package_esp32c6_cn_index.json

      - name: Upload assets to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            esp32c6-cn-package-${{ steps.release.outputs.tag }}.zip
            package_esp32c6_cn_index.json

      - name: Push latest JSON to gh-pages
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages
          git pull origin gh-pages || true
          git add package_esp32c6_cn_index.json
          git commit -m "Update latest package index for ${{ steps.release.outputs.tag }}" || echo "No changes to commit"
          git push origin gh-pages